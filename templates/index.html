<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat com Proxy LGPD</title>
    <link href="{{ url_for('static', path='/main.css') }}" rel="stylesheet" />
  </head>
  <body>
    <div class="page-container">
      <main class="main-content">
        <div class="chat-container">
          <div class="messages" id="messages">
            <div class="message assistant">
              <div class="message-content">
                Olá! Como posso ajudar você hoje?
              </div>
            </div>
          </div>
          <div class="loading" id="loading">Processando</div>
        </div>

        <div class="input-container">
          <textarea
            id="userInput"
            placeholder="Digite sua mensagem aqui..."
            rows="3"
          ></textarea>
          <button class="send-button" id="sendButton" onclick="sendMessage()">
            Enviar
          </button>
        </div>
      </main>

      <aside class="log-container">
        <h3 class="log-title">Logs do Processamento</h3>
        <div class="log-messages" id="log-messages">
          <div class="log-entry neutral">Aguardando envio de prompt...</div>
        </div>
      </aside>
    </div>

    <script>
      const messages = document.getElementById("messages");
      const userInput = document.getElementById("userInput");
      const sendButton = document.getElementById("sendButton");
      const loading = document.getElementById("loading");
      const logMessages = document.getElementById("log-messages");

      function addLogMessage(message, type = "info") {
        const logEntry = document.createElement("div");
        logEntry.classList.add("log-entry", type);
        logEntry.textContent = message;
        logMessages.appendChild(logEntry);
        logMessages.scrollTop = logMessages.scrollHeight;
      }

      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(isUser ? "user" : "assistant");

        const contentDiv = document.createElement("div");
        contentDiv.classList.add("message-content");
        contentDiv.textContent = content;

        messageDiv.appendChild(contentDiv);
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
      }

      function showLoading() {
        loading.style.display = "block";
        sendButton.disabled = true;
        sendButton.textContent = "Processando...";
      }

      function hideLoading() {
        loading.style.display = "none";
        sendButton.disabled = false;
        sendButton.textContent = "Enviar";
      }

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        userInput.value = "";
        showLoading();

        logMessages.innerHTML = "";
        addLogMessage("Conectando ao servidor...");

        try {
          const response = await fetch("/api/process-prompt-stream", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ original_prompt: message }),
          });

          if (!response.body) {
            throw new Error("A resposta do servidor não suporta streaming.");
          }

          const reader = response.body
            .pipeThrough(new TextDecoderStream())
            .getReader();

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunks = value
              .split("\n\n")
              .filter((c) => c.startsWith("data:"));

            for (const chunk of chunks) {
              const jsonString = chunk.replace("data: ", "");
              try {
                const data = JSON.parse(jsonString);

                if (data.type === "log") {
                  addLogMessage(data.message);
                } else if (data.type === "final_response") {
                  const finalData = data.payload;
                  addMessage(finalData.final_response || "Resposta recebida!");

                  console.log("PII Mascarados:", finalData.pii_masked);
                  console.log(
                    "Tópicos Sensíveis:",
                    finalData.sensitive_topics_detected
                  );

                  hideLoading();
                }
              } catch (e) {
                console.error(
                  "Erro ao processar chunk do stream:",
                  e,
                  jsonString
                );
              }
            }
          }
        } catch (error) {
          console.error("Erro na comunicação de stream:", error);
          addMessage("Erro ao processar sua mensagem. Tente novamente.");
          addLogMessage("Erro de conexão.", "error");
          hideLoading();
        }
      }

      userInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 150) + "px";
      });
    </script>
  </body>
</html>
